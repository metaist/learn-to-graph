<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Learn Graphing</title>
    <script
      src="https://code.jquery.com/jquery-3.5.1.min.js"
      integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
      crossorigin="anonymous"
    ></script>
    <script src="jquery.flot.js"></script>
    <style>
      #container {
        position: absolute;
        top: 0;
        bottom: 0;
        left: 0;
        right: 0;
        margin: 1rem;
      }
    </style>
  </head>
  <body>
    <div id="container"></div>
    <script>
      var app = {
        debug: true,
        $dom: $("#container"),
        plot: null,
        selected: null,
        dragging: false,

        points: {
          points: { show: true, fillColor: "black" },
          data: [],
        },

        options: {
          xaxis: { show: true, autoScale: "none", min: -5, max: 5 },
          yaxis: { show: true, autoScale: "none", min: -5, max: 5 },
          grid: { clickable: true, autoHighlight: false },
        },

        init: function () {
          app.plot = $.plot(app.$dom, [app.points], app.options);
          app.$dom.on({
            // "click": app.click,
            dblclick: app.dblclick,
            mousedown: app.drag_start,
          });

          $(window).on({
            resize: app.resize,
            keydown: app.keydown,
          });
          return app;
        },

        add: function (x, y) {
          app.debug && console.log("add", x, y);
          app.points.data.push([x, y]);
          app.redraw();
          return app;
        },

        remove: function (item) {
          app.points.data.splice(item.dataIndex, 1);
          app.redraw();
          return app;
        },

        select: function (item) {
          if (app.selected) app.unselect(app.selected);

          app.plot.highlight(item.seriesIndex, item.dataIndex);
          app.selected = item;
          return app;
        },

        unselect: function (item) {
          item = item || app.selected;
          if (!item) return app;

          app.plot.unhighlight(item.seriesIndex, item.dataIndex);
          app.selected = null;
          return app;
        },

        redraw: function () {
          app.plot.setData([app.points]);
          app.plot.setupGrid(false);
          app.plot.draw();
          return app;
        },

        /// Event Handlers ///

        getXY: function (e) {
          let offset = app.plot.getPlotOffset();
          let pos = app.plot.c2p({
            left: e.offsetX - offset.left,
            top: e.offsetY - offset.top,
          });
          return { x: pos.x, y: pos.y };
        },

        click: function (e, pos, item) {
          // item ? app.select(item) : app.unselect().add(pos.x, pos.y);
        },

        dblclick: function (e) {
          app.debug && console.log("dblclick");

          let pos = app.getXY(e);
          app.unselect().add(pos.x, pos.y);
        },

        drag_start: function (e) {
          var plot = app.plot,
            page = $.plot.browser.getPageXY(e),
            offset = plot.offset(),
            canvasX = page.X - offset.left,
            canvasY = page.Y - offset.top,
            radius = plot.getOptions().grid.mouseActiveRadius,
            item = plot.findNearbyItem(canvasX, canvasY, () => true, radius);

          if (!item) return;
          app.debug && console.log("drag_start");

          e.preventDefault();
          app.select(item);
          app.dragging = true;
          app.$dom.on("mousemove", app.drag_move);
          app.$dom.on("mouseup", app.drag_stop);
        },

        drag_move: function (e) {
          if (!app.dragging) return;
          app.debug && console.log("drag_move");

          e.preventDefault();
          let item = app.selected;
          let pos = app.getXY(e);

          app.unselect(item);
          app.points.data[item.dataIndex] = [pos.x, pos.y];
          app.redraw().select(item);
        },

        drag_stop: function (e) {
          if (!app.dragging) return;
          app.debug && console.log("drag_stop");

          e.preventDefault();
          app.dragging = false;
          app.$dom.off("mousemove", app.drag_move);
          app.$dom.off("mouseup", app.drag_stop);
        },

        keydown: function (e) {
          var item = app.selected;
          if (item && (e.keyCode == 8 || e.keyCode == 46)) {
            // backspace or delete
            app.debug && console.log("keydown");
            app.unselect(item).remove(item);
          } else if (e.keyCode == 27) {
            app.unselect();
          }
        },

        resize: function () {
          app.plot.resize();
          app.redraw();
        },
      };

      $(app.init);
    </script>
  </body>
</html>
